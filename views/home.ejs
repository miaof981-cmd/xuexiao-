<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>学校官网</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    header { margin-bottom: 16px; }
    /* Announcement modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background:#fff; border-radius: 12px; max-width: 860px; width: calc(100vw - 48px); max-height: calc(100vh - 48px); overflow:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .modal .modal-hd { padding: 14px 16px; border-bottom: 1px solid #eee; display:flex; justify-content: space-between; align-items:center; }
    .modal .modal-bd { padding: 16px; }
    .modal .modal-ft { padding: 12px 16px; border-top: 1px solid #eee; text-align: right; }
    .modal .close-btn { background:#1f6feb; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .pinned { color: #b30000; font-weight: bold; }
    form { display: grid; gap: 8px; }
    input, textarea, select, button { padding: 8px; font-size: 14px; }
    .error { color: #b30000; }
    /* 两列固定：左50%（主展示位） + 右50%（次级区） */
    .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
    .stack { display: grid; gap: 16px; align-content: start; }
    .poster-card { min-height: 360px; }
    /* 主公告图片需完整展示：不裁剪不拉伸，按原比例缩放 */
    .poster-media { display:block; width:100%; height:auto; object-fit: contain; border-radius:10px; margin:8px 0; }
    .clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .list { display:grid; gap:12px; }
    .list-item { padding:10px; border:1px solid #eee; border-radius:8px; background:#fafbff; }
  </style>
  </head>
<body>
  <div class="container">
    <header style="background:#2457A6; height:60px; color:#fff; border-radius:10px;">
      <div style="display:flex; align-items:center; height:100%; padding:0 16px; box-sizing:border-box;">
        <div style="flex:0 0 auto; display:flex; align-items:center; gap:12px;">
          <% if (site && site.logo) { %>
            <img src="<%= site.logo %>" alt="logo" style="height:40px; width:auto; display:block" />
          <% } else { %>
            <h1 style="margin:0; color:#fff; font-size:20px;">学校官网</h1>
          <% } %>
        </div>
        <div style="margin-left:auto; margin-right:16px; display:flex; align-items:center; gap:16px;">
          <a href="/login?role=admin" style="text-decoration:none;"><span style="display:inline-block; background:#fff; color:#2457A6; padding:8px 12px; border-radius:8px; font-weight:600;">管理员登录</span></a>
          <a href="/login?role=parent" style="text-decoration:none;"><span style="display:inline-block; background:#fff; color:#2457A6; padding:8px 12px; border-radius:8px; font-weight:600;">家长登录</span></a>
          <% if (parent) { %>
            <form method="post" action="/logout" style="display:flex; align-items:center; gap:8px;">
              <span style="margin-right:6px; white-space:nowrap;">欢迎，<%= parent.name %>（学号：<%= parent.studentId %>）</span>
              <button style="background:#fff;color:#2457A6; padding:8px 12px; border-radius:8px" type="submit">退出</button>
            </form>
          <% } %>
        </div>
      </div>
    </header>

    <% const banners = (site && site.banners) || []; %>
    <% if (banners.length) { %>
      <div class="doc-card" style="padding:0; overflow:hidden; margin-bottom:16px; position:relative;">
        <div id="carousel" style="position:relative;">
          <% banners.forEach((b, i) => { %>
            <img class="slide" src="<%= b %>" alt="banner" style="display:<%= i===0?'block':'none' %>; width:100%; height:auto;" />
          <% }) %>
          <button id="prev" style="position:absolute; left:8px; top:50%; transform:translateY(-50%);">‹</button>
          <button id="next" style="position:absolute; right:8px; top:50%; transform:translateY(-50%);">›</button>
        </div>
      </div>
      <script>
        (function(){
          const root = document.getElementById('carousel');
          if (!root) return;
          const slides = Array.from(root.querySelectorAll('.slide'));
          if (!slides.length) return;
          let idx = 0; let t;
          function show(i){ slides.forEach((s, j)=>{ s.style.display = j===i ? 'block' : 'none'; }); idx = i; }
          function next(){ show((idx+1)%slides.length); }
          function prev(){ show((idx-1+slides.length)%slides.length); }
          const n = document.getElementById('next');
          const p = document.getElementById('prev');
          if (n) n.onclick = ()=>{ next(); restart(); };
          if (p) p.onclick = ()=>{ prev(); restart(); };
          function restart(){ clearInterval(t); t=setInterval(next, 4000); }
          restart();
        })();
      </script>
    <% } else { %>
      <div class="doc-card" style="padding:0; overflow:hidden; margin-bottom:16px">
        <img src="/banners/blue-graduation-hero.svg" alt="欢迎横幅" style="display:block; width:100%; height:auto" />
      </div>
    <% } %>
    <% const mainA = (announcements && announcements.length) ? (announcements.find(a=>a.image) || announcements.find(a=>a.pinned) || announcements[0]) : null; %>
    <% const restA = (announcements || []).filter(a => mainA ? a.id !== mainA.id : true).filter(a=>!a.image).slice(0,8); %>
    <% const topArticles = (articles || []).slice(0,6); %>

    <div class="home-grid">
      <div>
        <% if (mainA) { %>
          <div class="doc-card poster-card" data-type="ann" data-id="<%= mainA.id %>" style="cursor:pointer">
            <div class="doc-header">
              <div class="doc-title">公告</div>
              <div class="doc-meta"><%= mainA.pinned ? '置顶' : '' %></div>
            </div>
            <div class="doc-body">
              <h2 style="margin:0 0 10px"><%= mainA.title %></h2>
              <% if (mainA.image) { %>
                <img class="poster-media" src="<%= mainA.image %>" alt="" />
              <% } %>
              <% const _mc = (mainA.content||''); const _mcShort = _mc.length>100 ? (_mc.slice(0,100)+'… 查看详情') : _mc; %>
              <p class="clamp-3"><%= _mcShort %></p>
            </div>
          </div>
        <% } %>
      </div>
      <div class="stack">
        <div class="doc-card">
          <div class="doc-header"><div class="doc-title">公告</div></div>
          <div class="doc-body">
            <% if (restA.length) { %>
              <div class="list">
                <% restA.forEach(a => { %>
                  <div class="list-item" data-type="ann" data-id="<%= a.id %>" style="cursor:pointer">
                    <div style="font-weight:700; margin-bottom:4px" class="clamp-2"><%= a.title %></div>
                    <% const _ac = (a.content||''); const _acShort = _ac.length>100 ? (_ac.slice(0,100)+'… 查看详情') : _ac; %>
                    <div class="clamp-2" style="color:#4b5563"><%= _acShort %></div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <p style="margin:0; color:#6b7280">暂无更多公告</p>
            <% } %>
          </div>
        </div>

        <div class="doc-card">
          <div class="doc-header"><div class="doc-title">文章</div></div>
          <div class="doc-body">
            <% if (topArticles.length) { %>
              <div class="list">
                <% topArticles.forEach(n => { %>
                  <div class="list-item" data-type="art" data-id="<%= n.id %>" style="cursor:pointer">
                    <div style="font-weight:700; margin-bottom:4px" class="clamp-2"><%= n.title %></div>
                    <% const _tc = (n.content||''); const _tcShort = _tc.length>100 ? (_tc.slice(0,100)+'… 查看详情') : _tc; %>
                    <div class="clamp-2" style="color:#4b5563"><%= _tcShort %></div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <p style="margin:0; color:#6b7280">暂无文章</p>
            <% } %>
          </div>
        </div>

        <% if (parent) { %>
          <div class="doc-card">
            <div class="doc-header"><div class="doc-title">家长入口</div></div>
            <div class="doc-body"><a href="/records"><button>查看学生档案</button></a></div>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Announcement Modal -->
  <div id="annModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-hd">
        <div class="ann-title" style="font-weight:700; font-size:18px"></div>
        <div class="ann-meta" style="color:#6b7280; font-size:12px"></div>
      </div>
      <div class="modal-bd">
        <div class="ann-image" style="margin-bottom:12px"></div>
        <div class="ann-content" style="white-space:pre-wrap; line-height:1.6; color:#111827"></div>
      </div>
      <div class="modal-ft">
        <button id="annClose" class="close-btn">关闭</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var anns = <%- JSON.stringify(announcements || []) %>;
      var arts = <%- JSON.stringify(articles || []) %>;
      var annMap = {}; (anns||[]).forEach(function(a){ annMap[a.id]=a; });
      var artMap = {}; (arts||[]).forEach(function(a){ artMap[a.id]=a; });
      function openModalBy(type, id){
        var a = (type==='art') ? artMap[id] : annMap[id];
        if(!a) return;
        var modal = document.getElementById('annModal');
        modal.querySelector('.ann-title').textContent = a.title || '';
        var meta = [];
        if (a.pinned) meta.push('置顶');
        if (a.createdAt) meta.push(new Date(a.createdAt).toLocaleString('zh-CN'));
        modal.querySelector('.ann-meta').textContent = meta.join(' · ');
        var imgBox = modal.querySelector('.ann-image');
        if (a.image) {
          imgBox.innerHTML = '<img src="'+a.image+'" alt="" style="max-width:100%; height:auto; border-radius:8px" />';
        } else { imgBox.innerHTML = ''; }
        modal.querySelector('.ann-content').textContent = a.content || '';
        modal.style.display = 'flex';
      }
      function closeModal(){ document.getElementById('annModal').style.display = 'none'; }
      document.getElementById('annClose').addEventListener('click', closeModal);
      document.getElementById('annModal').addEventListener('click', function(e){ if (e.target === this) closeModal(); });
      Array.prototype.forEach.call(document.querySelectorAll('[data-type][data-id]'), function(el){
        el.addEventListener('click', function(){ openModalBy(el.getAttribute('data-type'), el.getAttribute('data-id')); });
      });
    })();
  </script>
</body>
</html>


