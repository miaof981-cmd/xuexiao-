<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>学校官网</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .pinned { color: #b30000; font-weight: bold; }
    form { display: grid; gap: 8px; }
    input, textarea, select, button { padding: 8px; font-size: 14px; }
    .error { color: #b30000; }
    /* 两列固定：左50%（主展示位） + 右50%（次级区） */
    .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
    .stack { display: grid; gap: 16px; align-content: start; }
    .poster-card { min-height: 360px; }
    /* 主公告图片需完整展示：不裁剪不拉伸，按原比例缩放 */
    .poster-media { display:block; width:100%; height:auto; object-fit: contain; border-radius:10px; margin:8px 0; }
    .clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .list { display:grid; gap:12px; }
    .list-item { padding:10px; border:1px solid #eee; border-radius:8px; background:#fafbff; }
  </style>
  </head>
<body>
  <div class="container">
    <header style="background:#2457A6; height:60px; color:#fff; width:100%; border-radius:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; height:100%; padding:0 16px; box-sizing:border-box;">
        <div style="display:flex; align-items:center; gap:12px; flex:0 0 auto;">
          <% if (site && site.logo) { %>
            <img src="<%= site.logo %>" alt="logo" style="height:40px; width:auto; display:block" />
          <% } else { %>
            <h1 style="margin:0; color:#fff; font-size:20px;">学校官网</h1>
          <% } %>
        </div>
        <div style="flex:1 1 auto"></div>
        <div style="display:flex; align-items:center; gap:16px; flex:0 0 auto;">
          <a href="/login?role=admin" style="text-decoration:none;"><span style="display:inline-block; background:#fff; color:#2457A6; padding:8px 12px; border-radius:8px; font-weight:600;">管理员登录</span></a>
          <a href="/login?role=parent" style="text-decoration:none;"><span style="display:inline-block; background:#fff; color:#2457A6; padding:8px 12px; border-radius:8px; font-weight:600;">家长登录</span></a>
          <% if (parent) { %>
            <form method="post" action="/logout" style="display:flex; align-items:center; gap:8px;">
              <span style="margin-right:6px; white-space:nowrap;">欢迎，<%= parent.name %>（学号：<%= parent.studentId %>）</span>
              <button style="background:#fff;color:#2457A6; padding:8px 12px; border-radius:8px" type="submit">退出</button>
            </form>
          <% } %>
        </div>
      </div>
    </header>

    <% const banners = (site && site.banners) || []; %>
    <% if (banners.length) { %>
      <div class="doc-card" style="padding:0; overflow:hidden; margin-bottom:16px; position:relative;">
        <div id="carousel" style="position:relative;">
          <% banners.forEach((b, i) => { %>
            <img class="slide" src="<%= b %>" alt="banner" style="display:<%= i===0?'block':'none' %>; width:100%; height:auto;" />
          <% }) %>
          <button id="prev" style="position:absolute; left:8px; top:50%; transform:translateY(-50%);">‹</button>
          <button id="next" style="position:absolute; right:8px; top:50%; transform:translateY(-50%);">›</button>
        </div>
      </div>
      <script>
        (function(){
          const root = document.getElementById('carousel');
          if (!root) return;
          const slides = Array.from(root.querySelectorAll('.slide'));
          if (!slides.length) return;
          let idx = 0; let t;
          function show(i){ slides.forEach((s, j)=>{ s.style.display = j===i ? 'block' : 'none'; }); idx = i; }
          function next(){ show((idx+1)%slides.length); }
          function prev(){ show((idx-1+slides.length)%slides.length); }
          const n = document.getElementById('next');
          const p = document.getElementById('prev');
          if (n) n.onclick = ()=>{ next(); restart(); };
          if (p) p.onclick = ()=>{ prev(); restart(); };
          function restart(){ clearInterval(t); t=setInterval(next, 4000); }
          restart();
        })();
      </script>
    <% } else { %>
      <div class="doc-card" style="padding:0; overflow:hidden; margin-bottom:16px">
        <img src="/banners/blue-graduation-hero.svg" alt="欢迎横幅" style="display:block; width:100%; height:auto" />
      </div>
    <% } %>
    <% const mainA = (announcements && announcements.length) ? (announcements.find(a=>a.image) || announcements.find(a=>a.pinned) || announcements[0]) : null; %>
    <% const restA = (announcements || []).filter(a => mainA ? a.id !== mainA.id : true).filter(a=>!a.image).slice(0,8); %>
    <% const topArticles = (articles || []).slice(0,6); %>

    <div class="home-grid">
      <div>
        <% if (mainA) { %>
          <div class="doc-card poster-card">
            <div class="doc-header">
              <div class="doc-title">公告</div>
              <div class="doc-meta"><%= mainA.pinned ? '置顶' : '' %></div>
            </div>
            <div class="doc-body">
              <h2 style="margin:0 0 10px"><%= mainA.title %></h2>
              <% if (mainA.image) { %>
                <img class="poster-media" src="<%= mainA.image %>" alt="" />
              <% } %>
              <p class="clamp-3"><%= mainA.content %></p>
            </div>
          </div>
        <% } %>
      </div>
      <div class="stack">
        <div class="doc-card">
          <div class="doc-header"><div class="doc-title">公告</div></div>
          <div class="doc-body">
            <% if (restA.length) { %>
              <div class="list">
                <% restA.forEach(a => { %>
                  <div class="list-item">
                    <div style="font-weight:700; margin-bottom:4px" class="clamp-2"><%= a.title %></div>
                    <div class="clamp-2" style="color:#4b5563"><%= a.content %></div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <p style="margin:0; color:#6b7280">暂无更多公告</p>
            <% } %>
          </div>
        </div>

        <div class="doc-card">
          <div class="doc-header"><div class="doc-title">文章</div></div>
          <div class="doc-body">
            <% if (topArticles.length) { %>
              <div class="list">
                <% topArticles.forEach(n => { %>
                  <div class="list-item">
                    <div style="font-weight:700; margin-bottom:4px" class="clamp-2"><%= n.title %></div>
                    <div class="clamp-2" style="color:#4b5563"><%= n.content %></div>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <p style="margin:0; color:#6b7280">暂无文章</p>
            <% } %>
          </div>
        </div>

        <% if (parent) { %>
          <div class="doc-card">
            <div class="doc-header"><div class="doc-title">家长入口</div></div>
            <div class="doc-body"><a href="/records"><button>查看学生档案</button></a></div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</body>
</html>


